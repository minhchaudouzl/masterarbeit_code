---
title: "Data quality of reconstructed data"
author: "Minh Chau Do"
date: "2023-10-05"
output: rmdformats::robobook
---

```{r setup, include=FALSE, results='hide'}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)


library(survival)
library(survminer)


theme_set(theme_pubr())
theme_update(plot.title = element_text(hjust = 0.5),
             text = element_text(family = "serif", 
                            size = 14))

options(scipen=999)

# Dateipfad
setwd("D:/MA_Do_RProgramme/Rekonstruktion")


ggsave_workaround <- function(g){survminer:::.build_ggsurvplot(x = g,
                                                               surv.plot.height = NULL,
                                                               risk.table.height = NULL,
                                                               ncensor.plot.height = NULL)}
```


```{r funktionen, echo=FALSE, warning=FALSE, error=FALSE}
library(survival)
library(ggplot2)
library(survminer)

# Funktion zur Datenaufbereitung
prepare_data <- function(data_dir_blau, data_dir_rot) {
  data_b <- read.csv2(data_dir_blau, sep = ";", header = FALSE)
  data_r <- read.csv2(data_dir_rot, sep = ";", header = FALSE)

  data <- rbind(data_b, data_r)
  colnames(data) <- c("time", "status", "group")
  
  data$time <- as.numeric(data$time)
  data$status <- as.numeric(data$status)
  data$group <- as.numeric(data$group)
  
  # Überlebenskurven ohne senkrechte Linien am Ursprung
  data <- rbind(c(0, 0, 1), data)
  data <- rbind(c(0, 0, 0), data)
  
  return(data)
}

# Funktion zur Ergebnistabelle
create_result_table <- function(data, study_author,study_results) {
  # p-Wert (log-Rank)
  logRank <- survdiff(Surv(time, status) ~ group, rho = 0, data = data)$chisq
  logRank_p <- 1 - pchisq(logRank, 1)
  
  # Hazard Ratio
  cox_model <- coxph(Surv(time, status) ~ group, data = data)
  summary_cox_model <- summary(cox_model)
  
  hr <- exp(unname(cox_model$coefficients))
  
  # u.G. des KI
  hr_uG <- summary_cox_model$conf.int[3]
  
  # o.G. des KI
  hr_oG <- summary_cox_model$conf.int[4]
  
  # Ergebnistabelle erstellen
  if(is.numeric(study_results)){
    tab <- matrix(round(c(study_results, logRank_p, hr, hr_uG, hr_oG), 2), ncol = 4, byrow = TRUE)
  }
  else{
    tab <- matrix(c(study_results, round(logRank_p, 2), round(hr, 2), 
                      round(hr_uG, 2), round(hr_oG, 2)), 
              ncol=4, byrow=TRUE)
  }
  rownames(tab) <- c(study_author, 'Rekonstruktion')
  colnames(tab) <- c('p-Wert', 'HR', 'u.G. des KI', 'o.G. des KI')
  
  results <- as.table(tab)
  
  return(results)
}

# Funktion zum Erstellen und Speichern des Plots
create_and_save_plot <- function(data, plot_file, xlim_end, ylim_end,
                                 break_x, break_y) {
  # Überlebenskurven erstellen
  fit <- survfit(Surv(data$time, data$status) ~ data$group, data = data, type = "kaplan-meier")
  # Invertieren für Mortalität
  # fit$surv <- 1 - fit$surv
  
  # Plot erstellen
  plot <- ggsurvplot(fit, fun = "event", data = data, risk.table = TRUE,
                     break.time.by = break_x, break.y.by = break_y,
                     xlim = c(0, xlim_end), ylim = c(0, ylim_end),
                     xlab = "\n Months", ylab = "\n",
                     legend.labs = c("SAVR", "TAVR"),
                     palette = c("red", "blue"),
                     legend = c(0.8, 0.9),
                     legend.title = "", fontsize = 5,
                     font.x = c(14, "bold"),
                     font.caption = c(14, "black"),
                     font.legend = c(14, "black"),
                     font.tickslab = c(14, "black"),
                     font.table = c(14, "black"),
                     tables.theme = theme_cleantable(),
                     tables.height = 0.2,
                     risk.table.y.text = FALSE,
                     axes.offset = FALSE,
                     tables.y.text = FALSE,
                     width = 10)
  
  # Breite des Plots anpassen
  plot$plot <- plot$plot + theme(plot.margin = margin(t = 20, r = 20))
  
  # Ränder der "Number at Risk"-Tabelle anpassen
  plot$table <- plot$table + theme(plot.margin = margin(r = 20)) +
    coord_cartesian(xlim = c(0, xlim_end), clip = "off")
  
  # Plot speichern
  plot_rec <- ggsave_workaround(plot)
  ggsave(plot_file, plot = plot_rec)
}
```


# Plots

## Gleason et al.

```{r gleason, echo=FALSE, warning=FALSE, error=FALSE}
# Gleason et al.
gleason <- prepare_data("Gleason/gleason_blau_guyot.csv", "Gleason/gleason_rot_guyot.csv")

results_gleason <- create_result_table(gleason, "Gleason et al.",c(0.50, 0.93, 0.77, 1.14))

create_and_save_plot(data = gleason, plot_file = "Rekonstruierte Kurven/gleason_rec.png", 
                     xlim_end = 60, ylim_end = 1, break_x = 12, break_y = 0.1)
```

**Plot aus dem Artikel:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Kurven aus Paper/gleason.png)

**Plot aus den rekonstruierten Daten:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Rekonstruierte Kurven/gleason_rec.png)



## Jorgensen et al.

```{r jorgensen, echo=FALSE, warning=FALSE, error=FALSE}
# Jorgensen et al.
jorgensen <- prepare_data("Jorgensen/jorgensen_blau_guyot.csv", "Jorgensen/jorgensen_rot_guyot.csv")

results_jorgensen <- create_result_table(jorgensen, "Jorgensen et al.",c(0.94, 1.01, 0.74, 1.40))

create_and_save_plot(data = jorgensen, plot_file = "Rekonstruierte Kurven/jorgensen_rec.png", 
                     xlim_end = 96, ylim_end = 1, break_x = 12, break_y = 0.1)
```

**Plot aus dem Artikel:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Kurven aus Paper/jorgensen.jpg)

**Plot aus den rekonstruierten Daten:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Rekonstruierte Kurven/jorgensen_rec.png)



## Leon et al.

```{r leon, echo=FALSE, warning=FALSE, error=FALSE}
# Leon et al.
leon <- prepare_data("Leon/leon_blau_guyot.csv", "Leon/leon_rot_guyot.csv")

results_leon <- create_result_table(leon, "Leon et al.", c(0.25, 0.89, 0.73, 1.09))

create_and_save_plot(data = leon, plot_file = "Rekonstruierte Kurven/leon_rec.png", 
                     xlim_end = 24, ylim_end = 0.5, break_x = 3, break_y = 0.1)
```

**Plot aus dem Artikel:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Kurven aus Paper/leon.png)

**Plot aus den rekonstruierten Daten:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Rekonstruierte Kurven/leon_rec.png)

## Mack et al.

```{r mack, echo=FALSE, warning=FALSE, error=FALSE}
# Mack et al. (2012)
mack <- prepare_data("Mack/mack_blau_guyot.csv", "Mack/mack_rot_guyot.csv")

results_mack <- create_result_table(mack, "Mack et al.",c(0.07, 0.79, 0.61, 1.02))

create_and_save_plot(data = mack, plot_file = "Rekonstruierte Kurven/mack_rec.png", 
                     xlim_end = 60, ylim_end = 0.35, break_x = 12,
                     break_y = 0.05)
```


**Plot aus dem Artikel:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Kurven aus Paper/mack.png)

**Plot aus den rekonstruierten Daten:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Rekonstruierte Kurven/mack_rec.png)



## Makkar et al. (2012)

```{r makkar2012, echo=FALSE, warning=FALSE, error=FALSE}
# Makkar et al. (2012)
makkar2012 <- prepare_data("Makkar/2012/makkar2012_blau_guyot.csv", "Makkar/2012/makkar2012_rot_guyot.csv")

results_makkar2012 <- create_result_table(makkar2012, "Makkar et al. (2012)",c("< 0.001", 0.64, 0.49, 0.84))

create_and_save_plot(data = makkar2012, plot_file = "Rekonstruierte Kurven/makkar2012_rec.png", 
                     xlim_end = 24, ylim_end = 1, break_x = 6, break_y = 0.1)
```

**Plot aus dem Artikel:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Kurven aus Paper/Makkar_2012.png)

**Plot aus den rekonstruierten Daten:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Rekonstruierte Kurven/makkar2012_rec.png)

## Makkar et al. (2020)

```{r makkar2020, echo=FALSE, warning=FALSE, error=FALSE}
# Makkar et al. (2020)
makkar2020 <- prepare_data("Makkar/2020/makkar2020_blau_guyot.csv", "Makkar/2020/makkar2020_rot_guyot.csv")

results_makkar2020 <- create_result_table(makkar2020, "Makkar et al. (2020)",c(0.21, 1.09, 0.95, 1.25))

create_and_save_plot(data = makkar2020, plot_file = "Rekonstruierte Kurven/makkar2020_rec.png", 
                     xlim_end = 60, ylim_end = 0.8, break_x = 12, break_y = 0.1)
```

**Plot aus dem Artikel:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Kurven aus Paper/Makkar_2020.png)

**Plot aus den rekonstruierten Daten:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Rekonstruierte Kurven/makkar2020_rec.png)


## Popma et al. 

```{r popma, echo=FALSE, warning=FALSE, error=FALSE}
# Popma et al.
popma <- prepare_data("Medtronic/popma_blau_guyot.csv", "Medtronic/popma_rot_guyot.csv")

results_popma <- create_result_table(popma, "Popma et al.", c(NA, 0.62, NA, NA))

create_and_save_plot(data = popma, plot_file = "Rekonstruierte Kurven/popma_rec.png", 
                     xlim_end = 24, ylim_end = 0.1, break_x = 6, break_y = 0.02)
```

**Plot aus dem Artikel:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Kurven aus Paper/Medtronic.png)

**Plot aus den rekonstruierten Daten:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Rekonstruierte Kurven/popma_rec.png)


## Thyregod et al. 

```{r thyregod, echo=FALSE, warning=FALSE, error=FALSE}
# Thyregod et al.
thyregod <- prepare_data("Thyregod/thyregod_blau_guyot.csv", "Thyregod/thyregod_rot_guyot.csv")

results_thyregod <- create_result_table(thyregod, "Thyregod et al.", c(0.83, 1.06, NA, NA))

create_and_save_plot(data = thyregod, plot_file = "Rekonstruierte Kurven/thyregod_rec.png", 
                     xlim_end = 60, ylim_end = 0.7, break_x = 12, break_y = 0.1)
```

**Plot aus dem Artikel:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Kurven aus Paper/thyregod.png)

**Plot aus den rekonstruierten Daten:**

![](D:/MA_Do_RProgramme/Rekonstruktion/Rekonstruierte Kurven/thyregod_rec.png)


# Vergleich mit den veröffentlichten Daten

Um die Übereinstimmung der erzielten Rekonstruktionsresultate mit den in den Artikeln vorgestellten Daten zu bewerten, wurden p-Werte, Hazard Ratios mit unteren Grenzen des Konfidenzintervalls (KI) und oberen Grenzen des KI berechnet. Anschließend erfolgte ein Vergleich mit den veröffentlichten Ergebnissen.


```{r data quality, echo=FALSE, warning=FALSE, error=FALSE}
# Kombinieren der Tabellen mit rbind()
combined_table <- rbind(results_gleason, results_jorgensen)
combined_table <- rbind(combined_table, results_leon)
combined_table <- rbind(combined_table, results_mack)
combined_table <- rbind(combined_table, results_makkar2012)
combined_table <- rbind(combined_table, results_makkar2020)
combined_table <- rbind(combined_table, results_popma)
combined_table <- rbind(combined_table, results_thyregod)

# Ergebnis anzeigen
print(combined_table)
```





